<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频加密解密工具 v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .section {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.secondary {
            background-color: #95a5a6;
        }
        
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        #key-display {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 15px;
            word-break: break-all;
        }
        
        #file-info {
            background-color: #e8f4f8;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        #progress {
            width: 100%;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        #progress-bar {
            height: 100%;
            background-color: #2ecc71;
            width: 0%;
            transition: width 0.3s;
        }
        
        .audio-player {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        audio {
            width: 100%;
            margin-top: 10px;
        }
        
        .file-list {
            margin-top: 15px;
        }
        
        .file-item {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-item button {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .error {
            color: #e74c3c;
            margin-top: 10px;
        }
        
        .success {
            color: #2ecc71;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>音频加密解密工具</h1>
        
        <!-- 设备码和密钥生成 -->
        <div class="section">
            <h2>1. 设备码与密钥管理</h2>
            <div class="form-group">
                <label for="device-code">设备码:</label>
                <input type="text" id="device-code" placeholder="输入或生成设备码">
            </div>
            <div class="btn-group">
                <button onclick="generateDeviceCode()">生成设备码</button>
                <button onclick="generateKey()">生成密钥</button>
            </div>
            <div id="key-display">密钥将显示在这里</div>
        </div>
        
        <!-- 音频文件处理 -->
        <div class="section">
            <h2>2. 音频文件处理</h2>
            <div class="form-group">
                <label for="audio-file">选择音频文件 (最大250MB):</label>
                <input type="file" id="audio-file" accept=".mp3,.flac,.wav,.smp3,.sflac,.lgg,.lav">
            </div>
            <div id="file-info"></div>
            <div class="btn-group">
                <button onclick="encryptAudio()">加密</button>
                <button onclick="decryptAudio()">解密</button>
            </div>
            <div id="progress">
                <div id="progress-bar"></div>
            </div>
            <div id="message"></div>
        </div>
        
        <!-- 音频播放器 -->
        <div class="section">
            <h2>3. 音频播放</h2>
            <div class="audio-player">
                <div id="player-controls">
                    <button onclick="loadEncryptedAudio()">加载加密音频</button>
                    <button onclick="playDecryptedAudio()">播放解密音频</button>
                    <button onclick="toggleAutoDecrypt()">
                        <span id="auto-decrypt-status">开启自动解密</span>
                    </button>
                </div>
                <div id="decrypt-status" style="margin: 10px 0; color: #666;"></div>
                <audio id="audio-player" controls>
                    您的浏览器不支持音频元素。
                </audio>
            </div>
        </div>
        
        <!-- 处理后的文件列表 -->
        <div class="section">
            <h2>4. 处理后的文件</h2>
            <div id="file-list" class="file-list"></div>
        </div>
    </div>
    
    <script>
        // 全局变量
        let currentKey = null;
        let currentFile = null;
        let decryptedAudioBuffer = null;
        let isAutoDecryptEnabled = false;
        let decryptQueue = [];
        let isDecrypting = false;
        
        // 生成设备码
        function generateDeviceCode() {
            const deviceCode = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            document.getElementById('device-code').value = deviceCode;
        }
        
        // 根据设备码生成密钥
        async function generateKey() {
            const deviceCode = document.getElementById('device-code').value;
            if (!deviceCode) {
                showMessage('请先输入设备码', 'error');
                return;
            }
            
            // 使用SHA-256生成密钥
            const encoder = new TextEncoder();
            const data = encoder.encode(deviceCode);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const keyHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            // 截取前32字节作为AES密钥
            currentKey = keyHex.substring(0, 32);
            document.getElementById('key-display').textContent = `密钥: ${currentKey}`;
            showMessage('密钥生成成功', 'success');
        }
        
        // 显示消息
        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type;
        }
        
        // 更新进度条
        function updateProgress(progress) {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${progress}%`;
        }
        
        // 处理文件选择
        document.getElementById('audio-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // 检查文件大小 (250MB)
                if (file.size > 250 * 1024 * 1024) {
                    showMessage('文件大小超过250MB限制', 'error');
                    return;
                }
                
                currentFile = file;
                const fileInfo = `文件名: ${file.name}<br>文件大小: ${(file.size / (1024 * 1024)).toFixed(2)} MB<br>类型: ${file.type}`;
                document.getElementById('file-info').innerHTML = fileInfo;
                showMessage('文件已选择', 'success');
            }
        });
        
        // 加密音频
        async function encryptAudio() {
            if (!currentKey) {
                showMessage('请先生成密钥', 'error');
                return;
            }
            if (!currentFile) {
                showMessage('请先选择音频文件', 'error');
                return;
            }
            
            showMessage('开始加密...');
            updateProgress(0);
            
            try {
                const arrayBuffer = await currentFile.arrayBuffer();
                updateProgress(20);
                
                // 选择加密格式
                const fileExtension = currentFile.name.split('.').pop().toLowerCase();
                let encryptedFormat = 'smp3'; // 默认格式
                
                if (fileExtension === 'flac') {
                    encryptedFormat = 'sflac';
                } else if (fileExtension === 'mp3') {
                    encryptedFormat = 'smp3';
                }
                
                // 加密数据
                const encryptedData = await encryptData(arrayBuffer, currentKey);
                updateProgress(80);
                
                // 创建加密文件
                const encryptedFileName = currentFile.name.replace(/\.[^/.]+$/, '') + '.' + encryptedFormat;
                const blob = new Blob([encryptedData], { type: 'application/octet-stream' });
                
                // 添加到文件列表
                addFileToList(encryptedFileName, blob);
                
                updateProgress(100);
                showMessage('音频加密成功', 'success');
            } catch (error) {
                console.error('加密错误:', error);
                showMessage('加密失败: ' + error.message, 'error');
            }
        }
        
        // 解密音频
        async function decryptAudio() {
            if (!currentKey) {
                showMessage('请先生成密钥', 'error');
                return;
            }
            if (!currentFile) {
                showMessage('请先选择音频文件', 'error');
                return;
            }
            
            showMessage('开始解密...');
            updateProgress(0);
            
            try {
                const arrayBuffer = await currentFile.arrayBuffer();
                updateProgress(20);
                
                // 解密数据
                const decryptedData = await decryptData(arrayBuffer, currentKey);
                updateProgress(80);
                
                // 确定原始文件格式
                const fileExtension = currentFile.name.split('.').pop().toLowerCase();
                let originalFormat = 'mp3';
                
                if (fileExtension === 'sflac') {
                    originalFormat = 'flac';
                } else if (fileExtension === 'smp3') {
                    originalFormat = 'mp3';
                } else if (fileExtension === 'lgg' || fileExtension === 'lav') {
                    originalFormat = 'wav'; // 默认格式
                }
                
                // 创建解密文件
                const decryptedFileName = currentFile.name.replace(/\.[^/.]+$/, '') + '_decrypted.' + originalFormat;
                const blob = new Blob([decryptedData], { type: `audio/${originalFormat}` });
                
                // 添加到文件列表
                addFileToList(decryptedFileName, blob);
                
                updateProgress(100);
                showMessage('音频解密成功', 'success');
            } catch (error) {
                console.error('解密错误:', error);
                showMessage('解密失败: ' + error.message, 'error');
            }
        }
        
        // 加密数据
        async function encryptData(data, key) {
            // 使用AES-GCM加密
            const encoder = new TextEncoder();
            const keyData = encoder.encode(key);
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'AES-GCM' },
                false,
                ['encrypt']
            );
            
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                {
                    name: 'AES-GCM',
                    iv: iv
                },
                cryptoKey,
                data
            );
            
            // 合并IV和加密数据
            const result = new Uint8Array(iv.length + encrypted.byteLength);
            result.set(iv);
            result.set(new Uint8Array(encrypted), iv.length);
            
            return result;
        }
        
        // 解密数据
        async function decryptData(data, key) {
            // 使用AES-GCM解密
            const encoder = new TextEncoder();
            const keyData = encoder.encode(key);
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'AES-GCM' },
                false,
                ['decrypt']
            );
            
            // 分离IV和加密数据
            const iv = data.slice(0, 12);
            const encryptedData = data.slice(12);
            
            const decrypted = await crypto.subtle.decrypt(
                {
                    name: 'AES-GCM',
                    iv: iv
                },
                cryptoKey,
                encryptedData
            );
            
            return new Uint8Array(decrypted);
        }
        
        // 添加文件到列表
        function addFileToList(fileName, blob) {
            const fileList = document.getElementById('file-list');
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileUrl = URL.createObjectURL(blob);
            
            fileItem.innerHTML = `
                <span>${fileName}</span>
                <div>
                    <button onclick="downloadFile('${fileUrl}', '${fileName}')">下载</button>
                    <button onclick="playFile('${fileUrl}')">播放</button>
                </div>
            `;
            
            fileList.appendChild(fileItem);
        }
        
        // 下载文件
        function downloadFile(url, fileName) {
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // 播放文件
        function playFile(url) {
            const audioPlayer = document.getElementById('audio-player');
            audioPlayer.src = url;
            audioPlayer.play();
        }
        
        // 加载加密音频用于播放
        function loadEncryptedAudio() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.smp3,.sflac,.lgg,.lav';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file && currentKey) {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const decryptedData = await decryptData(arrayBuffer, currentKey);
                        
                        // 确定音频格式
                        const fileExtension = file.name.split('.').pop().toLowerCase();
                        let audioFormat = 'mp3';
                        
                        if (fileExtension === 'sflac') {
                            audioFormat = 'flac';
                        } else if (fileExtension === 'smp3') {
                            audioFormat = 'mp3';
                        } else {
                            audioFormat = 'wav';
                        }
                        
                        const blob = new Blob([decryptedData], { type: `audio/${audioFormat}` });
                        const url = URL.createObjectURL(blob);
                        
                        const audioPlayer = document.getElementById('audio-player');
                        audioPlayer.src = url;
                        showMessage('加密音频已加载，点击播放按钮播放', 'success');
                    } catch (error) {
                        showMessage('加载加密音频失败: ' + error.message, 'error');
                    }
                } else {
                    showMessage('请先生成密钥', 'error');
                }
            };
            input.click();
        }
        
        // 自动解密开关
        function toggleAutoDecrypt() {
            isAutoDecryptEnabled = !isAutoDecryptEnabled;
            const statusElement = document.getElementById('auto-decrypt-status');
            if (isAutoDecryptEnabled) {
                statusElement.textContent = '关闭自动解密';
                showMessage('已开启自动后台解密播放', 'success');
                // 初始化自动解密监听
                initAutoDecryptListener();
            } else {
                statusElement.textContent = '开启自动解密';
                showMessage('已关闭自动后台解密播放', 'info');
            }
        }
        
        // 初始化自动解密监听器
        function initAutoDecryptListener() {
            const audioPlayer = document.getElementById('audio-player');
            
            // 监听音频加载事件
            audioPlayer.addEventListener('error', handleAudioError);
            audioPlayer.addEventListener('loadedmetadata', handleAudioLoaded);
            
            // 监听文件拖放
            document.addEventListener('dragover', (e) => e.preventDefault());
            document.addEventListener('drop', handleFileDrop);
        }
        
        // 处理音频加载错误（可能是加密文件）
        async function handleAudioError(event) {
            if (!isAutoDecryptEnabled || !currentKey) return;
            
            const audioPlayer = event.target;
            const src = audioPlayer.src;
            
            // 检查是否是加密格式
            const encryptedExtensions = ['.smp3', '.sflac', '.lgg', '.lav'];
            const isEncrypted = encryptedExtensions.some(ext => src.includes(ext));
            
            if (isEncrypted) {
                try {
                    showDecryptStatus('检测到加密音频，正在后台解密...');
                    
                    // 下载加密文件
                    const response = await fetch(src);
                    const arrayBuffer = await response.arrayBuffer();
                    
                    // 解密文件
                    const decryptedData = await decryptData(arrayBuffer, currentKey);
                    
                    // 确定音频格式
                    let audioFormat = 'mp3';
                    if (src.includes('.sflac')) {
                        audioFormat = 'flac';
                    } else if (src.includes('.smp3')) {
                        audioFormat = 'mp3';
                    } else {
                        audioFormat = 'wav';
                    }
                    
                    // 创建解密后的Blob
                    const blob = new Blob([decryptedData], { type: `audio/${audioFormat}` });
                    const url = URL.createObjectURL(blob);
                    
                    // 替换音频源并播放
                    audioPlayer.src = url;
                    audioPlayer.play();
                    
                    showDecryptStatus('解密完成，正在播放...');
                    setTimeout(() => showDecryptStatus(''), 2000);
                } catch (error) {
                    console.error('自动解密失败:', error);
                    showDecryptStatus('自动解密失败: ' + error.message);
                }
            }
        }
        
        // 处理音频加载成功
        function handleAudioLoaded(event) {
            // 如果是正常加载的音频，清除解密状态
            showDecryptStatus('');
        }
        
        // 处理文件拖放
        function handleFileDrop(event) {
            event.preventDefault();
            
            if (!isAutoDecryptEnabled || !currentKey) return;
            
            const files = event.dataTransfer.files;
            for (const file of files) {
                const fileName = file.name.toLowerCase();
                const isEncrypted = ['.smp3', '.sflac', '.lgg', '.lav'].some(ext => fileName.endsWith(ext));
                
                if (isEncrypted) {
                    // 添加到解密队列
                    addToDecryptQueue(file);
                }
            }
        }
        
        // 添加到解密队列
        function addToDecryptQueue(file) {
            decryptQueue.push(file);
            showDecryptStatus(`已添加 ${file.name} 到解密队列，等待解密...`);
            processDecryptQueue();
        }
        
        // 处理解密队列
        async function processDecryptQueue() {
            if (isDecrypting || decryptQueue.length === 0) return;
            
            isDecrypting = true;
            const file = decryptQueue.shift();
            
            try {
                showDecryptStatus(`正在解密 ${file.name}...`);
                
                const arrayBuffer = await file.arrayBuffer();
                const decryptedData = await decryptData(arrayBuffer, currentKey);
                
                // 确定音频格式
                let audioFormat = 'mp3';
                const fileName = file.name.toLowerCase();
                if (fileName.endsWith('.sflac')) {
                    audioFormat = 'flac';
                } else if (fileName.endsWith('.smp3')) {
                    audioFormat = 'mp3';
                } else {
                    audioFormat = 'wav';
                }
                
                const blob = new Blob([decryptedData], { type: `audio/${audioFormat}` });
                const url = URL.createObjectURL(blob);
                
                // 自动播放
                const audioPlayer = document.getElementById('audio-player');
                audioPlayer.src = url;
                audioPlayer.play();
                
                showDecryptStatus(`解密完成，正在播放 ${file.name}`);
                setTimeout(() => showDecryptStatus(''), 2000);
            } catch (error) {
                console.error('队列解密失败:', error);
                showDecryptStatus(`解密 ${file.name} 失败: ${error.message}`);
            } finally {
                isDecrypting = false;
                // 继续处理下一个文件
                processDecryptQueue();
            }
        }
        
        // 显示解密状态
        function showDecryptStatus(message) {
            const statusElement = document.getElementById('decrypt-status');
            statusElement.textContent = message;
        }
        
        // 播放解密音频
        function playDecryptedAudio() {
            const audioPlayer = document.getElementById('audio-player');
            if (audioPlayer.src) {
                audioPlayer.play();
            } else {
                showMessage('请先加载音频文件', 'error');
            }
        }
    </script>
</body>
</html>