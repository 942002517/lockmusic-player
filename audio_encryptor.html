<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘åŠ å¯†è§£å¯†å·¥å…· v2.1.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .section {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.secondary {
            background-color: #95a5a6;
        }
        
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        #key-display {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 15px;
            word-break: break-all;
        }
        
        #file-info {
            background-color: #e8f4f8;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        #progress {
            width: 100%;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        #progress-bar {
            height: 100%;
            background-color: #2ecc71;
            width: 0%;
            transition: width 0.3s;
        }
        
        .audio-player {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        audio {
            width: 100%;
            margin-top: 10px;
        }
        
        .file-list {
            margin-top: 15px;
        }
        
        .file-item {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-item button {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .error {
            color: #e74c3c;
            margin-top: 10px;
        }
        
        .success {
            color: #2ecc71;
            margin-top: 10px;
        }
        
        /* é«˜çº§æ’­æ”¾å™¨æ ·å¼ */
        .advanced-player {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 30px;
            color: white;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .player-title {
            font-size: 24px;
            font-weight: bold;
        }
        
        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 20px;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(30deg);
        }
        
        .album-art {
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        
        .song-info {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .song-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .song-artist {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 4px;
        }
        
        .song-album {
            font-size: 14px;
            opacity: 0.6;
        }
        
        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 20px;
        }
        
        .control-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .control-btn.play-btn {
            width: 70px;
            height: 70px;
            background: white;
            color: #667eea;
            font-size: 24px;
        }
        
        .control-btn.play-btn:hover {
            transform: scale(1.1);
        }
        
        .progress-container {
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.8;
            margin-top: 8px;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .volume-slider {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            cursor: pointer;
            overflow: hidden;
        }
        
        .volume-fill {
            height: 100%;
            background: white;
            width: 80%;
            border-radius: 2px;
        }
        
        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .mode-switch {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .switch-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 5px;
        }
        
        .switch-btn.active {
            background: white;
            color: #667eea;
        }
        
        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            display: none;
        }
        
        .settings-panel.show {
            display: block;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }
        
        .setting-item {
            margin-bottom: 15px;
        }
        
        .setting-label {
            display: block;
            font-weight: bold;
            color: #555;
            margin-bottom: 8px;
        }
        
        .setting-value {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            color: #333;
        }
        
        /* ä¸€é”®åŠ è§£å¯†æŒ‰é’® */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .quick-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .quick-btn.encrypt {
            background: #2ecc71;
            color: white;
        }
        
        .quick-btn.decrypt {
            background: #3498db;
            color: white;
        }
        
        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* å¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3498db;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>éŸ³é¢‘åŠ å¯†è§£å¯†å·¥å…·</h1>
        
        <!-- è®¾å¤‡ç å’Œå¯†é’¥ç”Ÿæˆ (éšè—) -->
        <div class="section" style="display: none;">
            <h2>1. è®¾å¤‡ç ä¸å¯†é’¥ç®¡ç†</h2>
            <div class="form-group">
                <label for="device-code">è®¾å¤‡ç :</label>
                <input type="text" id="device-code" placeholder="è¾“å…¥æˆ–ç”Ÿæˆè®¾å¤‡ç ">
            </div>
            <div class="btn-group">
                <button onclick="generateDeviceCode()">ç”Ÿæˆè®¾å¤‡ç </button>
                <button onclick="generateKey()">ç”Ÿæˆå¯†é’¥</button>
            </div>
            <div id="key-display">å¯†é’¥å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
        </div>
        
        <!-- éŸ³é¢‘æ–‡ä»¶å¤„ç† -->
        <div class="section">
            <h2>1. éŸ³é¢‘æ–‡ä»¶å¤„ç†</h2>
            <div class="form-group">
                <label for="audio-file">é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ (æœ€å¤§250MB):</label>
                <input type="file" id="audio-file" accept=".mp3,.flac,.wav,.smp3,.sflac,.lgg,.lav" multiple>
            </div>
            <div class="form-group">
                <label for="folder-upload">æˆ–é€‰æ‹©æ–‡ä»¶å¤¹:</label>
                <input type="file" id="folder-upload" webkitdirectory mozdirectory directory accept=".mp3,.flac,.wav,.smp3,.sflac,.lgg,.lav">
            </div>
            <div class="btn-group">
                <button onclick="encryptAudio()">åŠ å¯†</button>
                <button onclick="decryptAudio()">è§£å¯†</button>
                <button onclick="manualScan()">æ‰‹åŠ¨æ‰«æå¯¼å…¥</button>
                <button onclick="uploadFolder()">ä¸Šä¼ æ–‡ä»¶å¤¹å¯¼å…¥</button>
            </div>
            <div id="progress">
                <div id="progress-bar"></div>
            </div>
            <div id="message"></div>
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>æ­Œæ›²åˆ—è¡¨</h3>
                    <div class="btn-group">
                        <button onclick="playAllSongs()">æ’­æ”¾å…¨éƒ¨</button>
                        <button onclick="clearSongList()">æ¸…ç©ºåˆ—è¡¨</button>
                    </div>
                </div>
                <div id="song-library" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                    <p>æš‚æ— æ­Œæ›²ï¼Œç‚¹å‡»"æ‰‹åŠ¨æ‰«æå¯¼å…¥"æˆ–"ä¸Šä¼ æ–‡ä»¶å¤¹å¯¼å…¥"æ·»åŠ æ­Œæ›²</p>
                </div>
                <div style="margin-top: 10px;">
                    <h4>å½“å‰æ’­æ”¾</h4>
                    <div id="current-playing" style="background: #f8f9fa; padding: 10px; border-radius: 4px; border-left: 4px solid #3498db;">
                        <p>æš‚æ— æ’­æ”¾å†…å®¹</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
        <div class="section">
            <h2>2. éŸ³é¢‘æ’­æ”¾</h2>
            
            <!-- é«˜çº§æ’­æ”¾å™¨ -->
            <div id="advanced-player" class="advanced-player">
                <div class="player-header">
                    <div class="player-title">éŸ³ä¹æ’­æ”¾å™¨</div>
                    <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
                </div>
                
                <div class="album-art">ğŸµ</div>
                
                <div class="song-info">
                    <div class="song-title" id="advanced-title">æœªé€‰æ‹©æ­Œæ›²</div>
                    <div class="song-artist" id="advanced-artist">æœªçŸ¥è‰ºæœ¯å®¶</div>
                    <div class="song-album" id="advanced-album">æœªçŸ¥ä¸“è¾‘</div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar" onclick="seekAudio(event)">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="time-display">
                        <span id="current-time">0:00</span>
                        <span id="total-time">0:00</span>
                    </div>
                </div>
                
                <div class="player-controls">
                    <button class="control-btn" onclick="loadEncryptedAudio()">ğŸ“</button>
                    <button class="control-btn" onclick="audioPlayer.currentTime -= 10">âª</button>
                    <button class="control-btn play-btn" id="advanced-play-btn" onclick="togglePlay()">â–¶ï¸</button>
                    <button class="control-btn" onclick="audioPlayer.currentTime += 10">â©</button>
                </div>
                
                <div class="volume-control">
                    <span>ğŸ”Š</span>
                    <div class="volume-slider" onclick="setVolume(event)">
                        <div class="volume-fill" id="volume-fill"></div>
                    </div>
                    <span>ğŸ”‡</span>
                </div>
                
                <div id="decrypt-status-advanced" style="margin-top: 20px; opacity: 0.8;"></div>
                
                <!-- ä¸€é”®æ“ä½œ -->
                <div class="quick-actions">
                    <button class="quick-btn encrypt" onclick="quickEncrypt()">ğŸ”’ ä¸€é”®åŠ å¯†</button>
                    <button class="quick-btn decrypt" onclick="quickDecrypt()">ğŸ”“ ä¸€é”®è§£å¯†</button>
                    <button class="quick-btn" style="background: #2ecc71; color: white;" onclick="oneClickScan()">ğŸ“ ä¸€é”®æ‰«æå¯¼å…¥</button>
                </div>
                
                <!-- è®¾ç½®é¢æ¿ -->
                <div id="settings-panel" class="settings-panel">
                    <div class="settings-title">è®¾ç½®</div>
                    
                    <div class="setting-item">
                        <div class="setting-label">è®¾å¤‡ç </div>
                        <input type="text" id="advanced-device-code" placeholder="è¾“å…¥æˆ–ç”Ÿæˆè®¾å¤‡ç " style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="generateDeviceCodeAdvanced()" style="flex: 1; padding: 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">ç”Ÿæˆè®¾å¤‡ç </button>
                            <button onclick="generateKeyAdvanced()" style="flex: 1; padding: 8px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer;">ç”Ÿæˆå¯†é’¥</button>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">å½“å‰å¯†é’¥</div>
                        <div class="setting-value" id="advanced-key-display">å¯†é’¥å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">è‡ªåŠ¨è§£å¯†çŠ¶æ€</div>
                        <div class="setting-value" id="advanced-auto-decrypt-status">å·²å…³é—­</div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">éŸ³é¢‘åŠ å¯†ä¿æŠ¤</div>
                        <div style="display: flex; align-items: center;">
                            <label class="switch">
                                <input type="checkbox" id="encryption-protection-switch" checked>
                                <span class="slider round"></span>
                            </label>
                            <span style="margin-left: 10px;" id="encryption-protection-status">å·²å¼€å¯</span>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">å¯†é’¥ç®¡ç†</div>
                        <button onclick="regenerateAllKeys()" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px;">é‡æ–°ç”Ÿæˆ5ä¸ªå¯†é’¥</button>
                        
                        <!-- è‡ªä¸»æ·»åŠ å¯†é’¥åŠŸèƒ½ -->
                        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                            <input type="text" id="new-key-input" placeholder="è¾“å…¥32ä½åå…­è¿›åˆ¶å¯†é’¥" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                            <button onclick="addKey()" style="padding: 8px 16px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer;">æ·»åŠ å¯†é’¥</button>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong>å¯†é’¥åˆ—è¡¨:</strong>
                        </div>
                        <div id="key-list" style="max-height: 300px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <!-- å¯†é’¥åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å¤„ç†åçš„æ–‡ä»¶åˆ—è¡¨ -->
        <div class="section">
            <h2>3. å¤„ç†åçš„æ–‡ä»¶</h2>
            <div id="file-list" class="file-list"></div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentKey = null;
        let currentFile = null;
        let decryptedAudioBuffer = null;
        const isAutoDecryptEnabled = true; // è‡ªåŠ¨è§£å¯†åŠŸèƒ½å§‹ç»ˆå¼€å¯ï¼Œä¸å¯ä¿®æ”¹
        let isEncryptionProtectionEnabled = true; // éŸ³é¢‘åŠ å¯†ä¿æŠ¤åŠŸèƒ½å¼€å…³
        let decryptQueue = [];
        let isDecrypting = false;
        
        // ç”Ÿæˆè®¾å¤‡ç 
        function generateDeviceCode() {
            const deviceCode = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            document.getElementById('device-code').value = deviceCode;
        }
        
        // æ ¹æ®è®¾å¤‡ç ç”Ÿæˆå¯†é’¥
        async function generateKey() {
            const deviceCode = document.getElementById('device-code').value;
            if (!deviceCode) {
                showMessage('è¯·å…ˆè¾“å…¥è®¾å¤‡ç ', 'error');
                return;
            }
            
            // ä½¿ç”¨SHA-256ç”Ÿæˆå¯†é’¥
            const encoder = new TextEncoder();
            const data = encoder.encode(deviceCode);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const keyHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            // æˆªå–å‰32å­—èŠ‚ä½œä¸ºAESå¯†é’¥
            currentKey = keyHex.substring(0, 32);
            document.getElementById('key-display').textContent = `å¯†é’¥: ${currentKey}`;
            showMessage('å¯†é’¥ç”ŸæˆæˆåŠŸ', 'success');
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type;
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(progress) {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${progress}%`;
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        document.getElementById('audio-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å° (250MB)
                if (file.size > 250 * 1024 * 1024) {
                    showMessage('æ–‡ä»¶å¤§å°è¶…è¿‡250MBé™åˆ¶', 'error');
                    return;
                }
                
                currentFile = file;
                const fileInfo = `æ–‡ä»¶å: ${file.name}<br>æ–‡ä»¶å¤§å°: ${(file.size / (1024 * 1024)).toFixed(2)} MB<br>ç±»å‹: ${file.type}`;
                document.getElementById('file-info').innerHTML = fileInfo;
                showMessage('æ–‡ä»¶å·²é€‰æ‹©', 'success');
            }
        });
        
        // åŠ å¯†éŸ³é¢‘
        async function encryptAudio() {
            if (!isEncryptionProtectionEnabled) {
                showMessage('éŸ³é¢‘åŠ å¯†ä¿æŠ¤åŠŸèƒ½å·²å…³é—­ï¼Œæ— æ³•è¿›è¡ŒåŠ å¯†æ“ä½œ', 'error');
                return;
            }
            if (!currentKey) {
                showMessage('è¯·å…ˆç”Ÿæˆå¯†é’¥', 'error');
                return;
            }
            if (!currentFile) {
                showMessage('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶', 'error');
                return;
            }
            
            showMessage('å¼€å§‹åŠ å¯†...');
            updateProgress(0);
            
            try {
                const arrayBuffer = await currentFile.arrayBuffer();
                updateProgress(20);
                
                // é€‰æ‹©åŠ å¯†æ ¼å¼
                const fileExtension = currentFile.name.split('.').pop().toLowerCase();
                let encryptedFormat = 'smp3'; // é»˜è®¤æ ¼å¼
                
                if (fileExtension === 'flac') {
                    encryptedFormat = 'sflac';
                } else if (fileExtension === 'mp3') {
                    encryptedFormat = 'smp3';
                }
                
                // åŠ å¯†æ•°æ®
                const encryptedData = await encryptData(arrayBuffer, currentKey);
                updateProgress(80);
                
                // åˆ›å»ºåŠ å¯†æ–‡ä»¶
                const encryptedFileName = currentFile.name.replace(/\.[^/.]+$/, '') + '.' + encryptedFormat;
                const blob = new Blob([encryptedData], { type: 'application/octet-stream' });
                
                // æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
                addFileToList(encryptedFileName, blob);
                
                updateProgress(100);
                showMessage('éŸ³é¢‘åŠ å¯†æˆåŠŸ', 'success');
            } catch (error) {
                console.error('åŠ å¯†é”™è¯¯:', error);
                showMessage('åŠ å¯†å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // è§£å¯†éŸ³é¢‘
        async function decryptAudio() {
            if (!isEncryptionProtectionEnabled) {
                showMessage('éŸ³é¢‘åŠ å¯†ä¿æŠ¤åŠŸèƒ½å·²å…³é—­ï¼Œæ— æ³•è¿›è¡Œè§£å¯†æ“ä½œ', 'error');
                return;
            }
            if (!currentKey) {
                showMessage('è¯·å…ˆç”Ÿæˆå¯†é’¥', 'error');
                return;
            }
            if (!currentFile) {
                showMessage('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶', 'error');
                return;
            }
            
            showMessage('å¼€å§‹è§£å¯†...');
            updateProgress(0);
            
            try {
                const arrayBuffer = await currentFile.arrayBuffer();
                updateProgress(20);
                
                // è§£å¯†æ•°æ®
                const decryptedData = await decryptData(arrayBuffer, currentKey);
                updateProgress(80);
                
                // ç¡®å®šåŸå§‹æ–‡ä»¶æ ¼å¼
                const fileExtension = currentFile.name.split('.').pop().toLowerCase();
                let originalFormat = 'mp3';
                
                if (fileExtension === 'sflac') {
                    originalFormat = 'flac';
                } else if (fileExtension === 'smp3') {
                    originalFormat = 'mp3';
                } else if (fileExtension === 'lgg' || fileExtension === 'lav') {
                    originalFormat = 'wav'; // é»˜è®¤æ ¼å¼
                }
                
                // åˆ›å»ºè§£å¯†æ–‡ä»¶
                const decryptedFileName = currentFile.name.replace(/\.[^/.]+$/, '') + '_decrypted.' + originalFormat;
                const blob = new Blob([decryptedData], { type: `audio/${originalFormat}` });
                
                // æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
                addFileToList(decryptedFileName, blob);
                
                updateProgress(100);
                showMessage('éŸ³é¢‘è§£å¯†æˆåŠŸ', 'success');
            } catch (error) {
                console.error('è§£å¯†é”™è¯¯:', error);
                showMessage('è§£å¯†å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ å¯†æ•°æ®
        async function encryptData(data, key) {
            // ä½¿ç”¨AES-GCMåŠ å¯†
            const encoder = new TextEncoder();
            const keyData = encoder.encode(key);
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'AES-GCM' },
                false,
                ['encrypt']
            );
            
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                {
                    name: 'AES-GCM',
                    iv: iv
                },
                cryptoKey,
                data
            );
            
            // åˆå¹¶IVå’ŒåŠ å¯†æ•°æ®
            const result = new Uint8Array(iv.length + encrypted.byteLength);
            result.set(iv);
            result.set(new Uint8Array(encrypted), iv.length);
            
            return result;
        }
        
        // è§£å¯†æ•°æ®
        async function decryptData(data, key) {
            // ä½¿ç”¨AES-GCMè§£å¯†
            const encoder = new TextEncoder();
            const keyData = encoder.encode(key);
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'AES-GCM' },
                false,
                ['decrypt']
            );
            
            // åˆ†ç¦»IVå’ŒåŠ å¯†æ•°æ®
            const iv = data.slice(0, 12);
            const encryptedData = data.slice(12);
            
            const decrypted = await crypto.subtle.decrypt(
                {
                    name: 'AES-GCM',
                    iv: iv
                },
                cryptoKey,
                encryptedData
            );
            
            return new Uint8Array(decrypted);
        }
        
        // æ·»åŠ æ–‡ä»¶åˆ°åˆ—è¡¨
        function addFileToList(fileName, blob) {
            const fileList = document.getElementById('file-list');
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileUrl = URL.createObjectURL(blob);
            
            fileItem.innerHTML = `
                <span>${fileName}</span>
                <div>
                    <button onclick="downloadFile('${fileUrl}', '${fileName}')">ä¸‹è½½</button>
                    <button onclick="playFile('${fileUrl}')">æ’­æ”¾</button>
                </div>
            `;
            
            fileList.appendChild(fileItem);
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(url, fileName) {
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // æ’­æ”¾æ–‡ä»¶
        function playFile(url) {
            const audioPlayer = document.getElementById('audio-player');
            audioPlayer.src = url;
            audioPlayer.play();
        }
        
        // åŠ è½½åŠ å¯†éŸ³é¢‘ç”¨äºæ’­æ”¾
        function loadEncryptedAudio() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.smp3,.sflac,.lgg,.lav';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file && currentKey) {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const decryptedData = await decryptData(arrayBuffer, currentKey);
                        
                        // ç¡®å®šéŸ³é¢‘æ ¼å¼
                        const fileExtension = file.name.split('.').pop().toLowerCase();
                        let audioFormat = 'mp3';
                        
                        if (fileExtension === 'sflac') {
                            audioFormat = 'flac';
                        } else if (fileExtension === 'smp3') {
                            audioFormat = 'mp3';
                        } else {
                            audioFormat = 'wav';
                        }
                        
                        const blob = new Blob([decryptedData], { type: `audio/${audioFormat}` });
                        const url = URL.createObjectURL(blob);
                        
                        const audioPlayer = document.getElementById('audio-player');
                        audioPlayer.src = url;
                        showMessage('åŠ å¯†éŸ³é¢‘å·²åŠ è½½ï¼Œç‚¹å‡»æ’­æ”¾æŒ‰é’®æ’­æ”¾', 'success');
                    } catch (error) {
                        showMessage('åŠ è½½åŠ å¯†éŸ³é¢‘å¤±è´¥: ' + error.message, 'error');
                    }
                } else {
                    showMessage('è¯·å…ˆç”Ÿæˆå¯†é’¥', 'error');
                }
            };
            input.click();
        }
        
        // è‡ªåŠ¨è§£å¯†åŠŸèƒ½å·²é»˜è®¤å¼€å¯ï¼Œä¸”ä¸å¯å…³é—­
        function toggleAutoDecrypt() {
            // æç¤ºç”¨æˆ·è‡ªåŠ¨è§£å¯†åŠŸèƒ½å§‹ç»ˆå¼€å¯ï¼Œä¸å¯å…³é—­
            showMessage('è‡ªåŠ¨è§£å¯†åŠŸèƒ½å§‹ç»ˆå¼€å¯ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ', 'info');
        }
        
        // åˆå§‹åŒ–è‡ªåŠ¨è§£å¯†ç›‘å¬å™¨
        function initAutoDecryptListener() {
            const audioPlayer = document.getElementById('audio-player');
            
            // ç›‘å¬éŸ³é¢‘åŠ è½½äº‹ä»¶
            audioPlayer.addEventListener('error', handleAudioError);
            audioPlayer.addEventListener('loadedmetadata', handleAudioLoaded);
            
            // ç›‘å¬æ–‡ä»¶æ‹–æ”¾
            document.addEventListener('dragover', (e) => e.preventDefault());
            document.addEventListener('drop', handleFileDrop);
        }
        
        // å¤„ç†éŸ³é¢‘åŠ è½½é”™è¯¯ï¼ˆå¯èƒ½æ˜¯åŠ å¯†æ–‡ä»¶ï¼‰
        async function handleAudioError(event) {
            if (!isAutoDecryptEnabled || !currentKey) return;
            
            const audioPlayer = event.target;
            const src = audioPlayer.src;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯åŠ å¯†æ ¼å¼
            const encryptedExtensions = ['.smp3', '.sflac', '.lgg', '.lav'];
            const isEncrypted = encryptedExtensions.some(ext => src.includes(ext));
            
            if (isEncrypted) {
                try {
                    showDecryptStatus('æ£€æµ‹åˆ°åŠ å¯†éŸ³é¢‘ï¼Œæ­£åœ¨åå°è§£å¯†...');
                    
                    // ä¸‹è½½åŠ å¯†æ–‡ä»¶
                    const response = await fetch(src);
                    const arrayBuffer = await response.arrayBuffer();
                    
                    // è§£å¯†æ–‡ä»¶
                    const decryptedData = await decryptData(arrayBuffer, currentKey);
                    
                    // ç¡®å®šéŸ³é¢‘æ ¼å¼
                    let audioFormat = 'mp3';
                    if (src.includes('.sflac')) {
                        audioFormat = 'flac';
                    } else if (src.includes('.smp3')) {
                        audioFormat = 'mp3';
                    } else {
                        audioFormat = 'wav';
                    }
                    
                    // åˆ›å»ºè§£å¯†åçš„Blob
                    const blob = new Blob([decryptedData], { type: `audio/${audioFormat}` });
                    const url = URL.createObjectURL(blob);
                    
                    // æ›¿æ¢éŸ³é¢‘æºå¹¶æ’­æ”¾
                    audioPlayer.src = url;
                    audioPlayer.play();
                    
                    showDecryptStatus('è§£å¯†å®Œæˆï¼Œæ­£åœ¨æ’­æ”¾...');
                    setTimeout(() => showDecryptStatus(''), 2000);
                } catch (error) {
                    console.error('è‡ªåŠ¨è§£å¯†å¤±è´¥:', error);
                    showDecryptStatus('è‡ªåŠ¨è§£å¯†å¤±è´¥: ' + error.message);
                }
            }
        }
        
        // å¤„ç†éŸ³é¢‘åŠ è½½æˆåŠŸ
        function handleAudioLoaded(event) {
            // å¦‚æœæ˜¯æ­£å¸¸åŠ è½½çš„éŸ³é¢‘ï¼Œæ¸…é™¤è§£å¯†çŠ¶æ€
            showDecryptStatus('');
        }
        
        // å¤„ç†æ–‡ä»¶æ‹–æ”¾
        function handleFileDrop(event) {
            event.preventDefault();
            
            if (!isAutoDecryptEnabled || !currentKey) return;
            
            const files = event.dataTransfer.files;
            for (const file of files) {
                const fileName = file.name.toLowerCase();
                const isEncrypted = ['.smp3', '.sflac', '.lgg', '.lav'].some(ext => fileName.endsWith(ext));
                
                if (isEncrypted) {
                    // æ·»åŠ åˆ°è§£å¯†é˜Ÿåˆ—
                    addToDecryptQueue(file);
                }
            }
        }
        
        // æ·»åŠ åˆ°è§£å¯†é˜Ÿåˆ—
        function addToDecryptQueue(file) {
            decryptQueue.push(file);
            showDecryptStatus(`å·²æ·»åŠ  ${file.name} åˆ°è§£å¯†é˜Ÿåˆ—ï¼Œç­‰å¾…è§£å¯†...`);
            processDecryptQueue();
        }
        
        // å¤„ç†è§£å¯†é˜Ÿåˆ—
        async function processDecryptQueue() {
            if (isDecrypting || decryptQueue.length === 0) return;
            
            isDecrypting = true;
            const file = decryptQueue.shift();
            
            try {
                showDecryptStatus(`æ­£åœ¨è§£å¯† ${file.name}...`);
                
                const arrayBuffer = await file.arrayBuffer();
                const decryptedData = await decryptData(arrayBuffer, currentKey);
                
                // ç¡®å®šéŸ³é¢‘æ ¼å¼
                let audioFormat = 'mp3';
                const fileName = file.name.toLowerCase();
                if (fileName.endsWith('.sflac')) {
                    audioFormat = 'flac';
                } else if (fileName.endsWith('.smp3')) {
                    audioFormat = 'mp3';
                } else {
                    audioFormat = 'wav';
                }
                
                const blob = new Blob([decryptedData], { type: `audio/${audioFormat}` });
                const url = URL.createObjectURL(blob);
                
                // è‡ªåŠ¨æ’­æ”¾
                const audioPlayer = document.getElementById('audio-player');
                audioPlayer.src = url;
                audioPlayer.play();
                
                showDecryptStatus(`è§£å¯†å®Œæˆï¼Œæ­£åœ¨æ’­æ”¾ ${file.name}`);
                setTimeout(() => showDecryptStatus(''), 2000);
            } catch (error) {
                console.error('é˜Ÿåˆ—è§£å¯†å¤±è´¥:', error);
                showDecryptStatus(`è§£å¯† ${file.name} å¤±è´¥: ${error.message}`);
            } finally {
                isDecrypting = false;
                // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶
                processDecryptQueue();
            }
        }
        
        // æ˜¾ç¤ºè§£å¯†çŠ¶æ€
        function showDecryptStatus(message) {
            const statusElement = document.getElementById('decrypt-status');
            const advancedStatusElement = document.getElementById('decrypt-status-advanced');
            statusElement.textContent = message;
            advancedStatusElement.textContent = message;
        }
        
        // æ’­æ”¾è§£å¯†éŸ³é¢‘
        function playDecryptedAudio() {
            const audioPlayer = document.getElementById('audio-player');
            if (audioPlayer.src) {
                audioPlayer.play();
            } else {
                showMessage('è¯·å…ˆåŠ è½½éŸ³é¢‘æ–‡ä»¶', 'error');
            }
        }
        
        // æ›´æ–°é«˜çº§æ’­æ”¾å™¨çŠ¶æ€
        function updateAdvancedPlayer() {
            const audioPlayer = document.getElementById('audio-player');
            if (audioPlayer.src) {
                // è§£ææ­Œæ›²å…ƒæ•°æ®
                parseSongMetadata(audioPlayer.src);
            }
        }
        
        // è§£ææ­Œæ›²å…ƒæ•°æ®
        function parseSongMetadata(fileUrl) {
            // ä»æ–‡ä»¶åæå–åŸºæœ¬ä¿¡æ¯
            const fileName = fileUrl.split('/').pop().split('?')[0];
            const cleanName = fileName.replace(/\.[^/.]+$/, '');
            
            // ç®€å•è§£æï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„å…ƒæ•°æ®è§£æåº“ï¼‰
            let title = cleanName;
            let artist = 'æœªçŸ¥è‰ºæœ¯å®¶';
            let album = 'æœªçŸ¥ä¸“è¾‘';
            
            // å°è¯•ä»æ–‡ä»¶åä¸­æå–è‰ºæœ¯å®¶å’Œæ ‡é¢˜ï¼ˆæ ¼å¼ï¼šè‰ºæœ¯å®¶ - æ ‡é¢˜ï¼‰
            const dashIndex = cleanName.indexOf(' - ');
            if (dashIndex > -1) {
                artist = cleanName.substring(0, dashIndex);
                title = cleanName.substring(dashIndex + 3);
            }
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('advanced-title').textContent = title;
            document.getElementById('advanced-artist').textContent = artist;
            document.getElementById('advanced-album').textContent = album;
        }
        
        // åˆ‡æ¢æ’­æ”¾çŠ¶æ€
        function togglePlay() {
            const audioPlayer = document.getElementById('audio-player');
            const playBtn = document.getElementById('advanced-play-btn');
            
            if (audioPlayer.paused) {
                audioPlayer.play();
                playBtn.textContent = 'â¸ï¸';
            } else {
                audioPlayer.pause();
                playBtn.textContent = 'â–¶ï¸';
            }
        }
        
        // è·³è½¬åˆ°æŒ‡å®šä½ç½®
        function seekAudio(event) {
            const audioPlayer = document.getElementById('audio-player');
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const pos = (event.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = pos * audioPlayer.duration;
        }
        
        // è®¾ç½®éŸ³é‡
        function setVolume(event) {
            const audioPlayer = document.getElementById('audio-player');
            const volumeSlider = event.currentTarget;
            const rect = volumeSlider.getBoundingClientRect();
            const pos = (event.clientX - rect.left) / rect.width;
            audioPlayer.volume = Math.max(0, Math.min(1, pos));
            updateVolumeDisplay();
        }
        
        // æ›´æ–°éŸ³é‡æ˜¾ç¤º
        function updateVolumeDisplay() {
            const audioPlayer = document.getElementById('audio-player');
            const volumeFill = document.getElementById('volume-fill');
            volumeFill.style.width = `${audioPlayer.volume * 100}%`;
        }
        
        // åˆ‡æ¢è®¾ç½®é¢æ¿
        function toggleSettings() {
            const settingsPanel = document.getElementById('settings-panel');
            settingsPanel.classList.toggle('show');
        }
        
        // é«˜çº§æ¨¡å¼ç”Ÿæˆè®¾å¤‡ç 
        function generateDeviceCodeAdvanced() {
            const deviceCode = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            document.getElementById('device-code').value = deviceCode;
            document.getElementById('advanced-device-code').value = deviceCode;
        }
        
        // é«˜çº§æ¨¡å¼ç”Ÿæˆå¯†é’¥
        async function generateKeyAdvanced() {
            const deviceCode = document.getElementById('advanced-device-code').value;
            if (!deviceCode) {
                showMessage('è¯·å…ˆè¾“å…¥è®¾å¤‡ç ', 'error');
                return;
            }
            
            // æ›´æ–°åŸºç¡€æ¨¡å¼çš„è®¾å¤‡ç 
            document.getElementById('device-code').value = deviceCode;
            
            // è°ƒç”¨åŸæœ‰çš„å¯†é’¥ç”Ÿæˆå‡½æ•°
            await generateKey();
            
            // æ›´æ–°é«˜çº§æ¨¡å¼çš„å¯†é’¥æ˜¾ç¤º
            updateAdvancedKeyDisplay();
        }
        
        // æ›´æ–°é«˜çº§æ¨¡å¼çš„å¯†é’¥æ˜¾ç¤º
        function updateAdvancedKeyDisplay() {
            const keyDisplay = document.getElementById('advanced-key-display');
            keyDisplay.textContent = currentKey ? `å¯†é’¥: ${currentKey}` : 'å¯†é’¥å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ';
        }
        
        // æ›´æ–°è‡ªåŠ¨è§£å¯†çŠ¶æ€æ˜¾ç¤º
        function updateAutoDecryptStatus() {
            const statusElement = document.getElementById('advanced-auto-decrypt-status');
            statusElement.textContent = 'å·²å¼€å¯'; // è‡ªåŠ¨è§£å¯†åŠŸèƒ½å§‹ç»ˆå¼€å¯
        }
        
        // åˆ‡æ¢éŸ³é¢‘åŠ å¯†ä¿æŠ¤åŠŸèƒ½
        function toggleEncryptionProtection() {
            const switchElement = document.getElementById('encryption-protection-switch');
            const statusElement = document.getElementById('encryption-protection-status');
            
            isEncryptionProtectionEnabled = switchElement.checked;
            statusElement.textContent = isEncryptionProtectionEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­';
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('isEncryptionProtectionEnabled', isEncryptionProtectionEnabled);
            
            showMessage(`éŸ³é¢‘åŠ å¯†ä¿æŠ¤å·²${isEncryptionProtectionEnabled ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
        }
        
        // æ›´æ–°éŸ³é¢‘åŠ å¯†ä¿æŠ¤çŠ¶æ€æ˜¾ç¤º
        function updateEncryptionProtectionStatus() {
            const switchElement = document.getElementById('encryption-protection-switch');
            const statusElement = document.getElementById('encryption-protection-status');
            
            switchElement.checked = isEncryptionProtectionEnabled;
            statusElement.textContent = isEncryptionProtectionEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­';
        }
        
        // ä¸€é”®åŠ å¯†
        function quickEncrypt() {
            if (!isEncryptionProtectionEnabled) {
                showMessage('éŸ³é¢‘åŠ å¯†ä¿æŠ¤åŠŸèƒ½å·²å…³é—­ï¼Œæ— æ³•è¿›è¡ŒåŠ å¯†æ“ä½œ', 'error');
                return;
            }
            const audioPlayer = document.getElementById('audio-player');
            if (!audioPlayer.src) {
                showMessage('è¯·å…ˆåŠ è½½éŸ³é¢‘æ–‡ä»¶', 'error');
                return;
            }
            
            // ä»å½“å‰æ’­æ”¾çš„éŸ³é¢‘åˆ›å»ºæ–‡ä»¶å¯¹è±¡
            fetch(audioPlayer.src)
                .then(response => response.blob())
                .then(blob => {
                    // åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¯¹è±¡
                    const fileName = audioPlayer.src.split('/').pop().split('?')[0];
                    const file = new File([blob], fileName, { type: blob.type });
                    
                    // ä¿å­˜å½“å‰æ–‡ä»¶å¹¶è°ƒç”¨åŠ å¯†å‡½æ•°
                    currentFile = file;
                    encryptAudio();
                })
                .catch(error => {
                    showMessage('è·å–å½“å‰éŸ³é¢‘æ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
                });
        }
        
        // ä¸€é”®è§£å¯†
        function quickDecrypt() {
            if (!isEncryptionProtectionEnabled) {
                showMessage('éŸ³é¢‘åŠ å¯†ä¿æŠ¤åŠŸèƒ½å·²å…³é—­ï¼Œæ— æ³•è¿›è¡Œè§£å¯†æ“ä½œ', 'error');
                return;
            }
            const audioPlayer = document.getElementById('audio-player');
            if (!audioPlayer.src) {
                showMessage('è¯·å…ˆåŠ è½½éŸ³é¢‘æ–‡ä»¶', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯åŠ å¯†æ ¼å¼
            const encryptedExtensions = ['.smp3', '.sflac', '.lgg', '.lav'];
            const isEncrypted = encryptedExtensions.some(ext => audioPlayer.src.includes(ext));
            
            if (!isEncrypted) {
                showMessage('å½“å‰éŸ³é¢‘ä¸æ˜¯åŠ å¯†æ ¼å¼', 'error');
                return;
            }
            
            // ä»å½“å‰æ’­æ”¾çš„éŸ³é¢‘åˆ›å»ºæ–‡ä»¶å¯¹è±¡
            fetch(audioPlayer.src)
                .then(response => response.blob())
                .then(blob => {
                    // åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¯¹è±¡
                    const fileName = audioPlayer.src.split('/').pop().split('?')[0];
                    const file = new File([blob], fileName, { type: blob.type });
                    
                    // ä¿å­˜å½“å‰æ–‡ä»¶å¹¶è°ƒç”¨è§£å¯†å‡½æ•°
                    currentFile = file;
                    decryptAudio();
                })
                .catch(error => {
                    showMessage('è·å–å½“å‰éŸ³é¢‘æ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
                });
        }
        
        // åˆå§‹åŒ–éŸ³é¢‘äº‹ä»¶ç›‘å¬
        function initAudioEventListeners() {
            const audioPlayer = document.getElementById('audio-player');
            
            // æ’­æ”¾çŠ¶æ€å˜åŒ–
            audioPlayer.addEventListener('play', () => {
                const playBtn = document.getElementById('advanced-play-btn');
                if (playBtn) {
                    playBtn.textContent = 'â¸ï¸';
                }
            });
            
            audioPlayer.addEventListener('pause', () => {
                const playBtn = document.getElementById('advanced-play-btn');
                if (playBtn) {
                    playBtn.textContent = 'â–¶ï¸';
                }
            });
            
            // æ—¶é—´æ›´æ–°
            audioPlayer.addEventListener('timeupdate', () => {
                updateProgressDisplay();
            });
            
            // åŠ è½½å®Œæˆ
            audioPlayer.addEventListener('loadedmetadata', () => {
                updateProgressDisplay();
                parseSongMetadata(audioPlayer.src);
            });
            
            // éŸ³é‡å˜åŒ–
            audioPlayer.addEventListener('volumechange', () => {
                updateVolumeDisplay();
            });
        }
        
        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgressDisplay() {
            const audioPlayer = document.getElementById('audio-player');
            const progressFill = document.getElementById('progress-fill');
            const currentTimeElement = document.getElementById('current-time');
            const totalTimeElement = document.getElementById('total-time');
            
            if (progressFill && !isNaN(audioPlayer.duration)) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = `${progress}%`;
            }
            
            if (currentTimeElement) {
                currentTimeElement.textContent = formatTime(audioPlayer.currentTime);
            }
            
            if (totalTimeElement && !isNaN(audioPlayer.duration)) {
                totalTimeElement.textContent = formatTime(audioPlayer.duration);
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // é‡å†™åŸæœ‰çš„generateKeyå‡½æ•°ï¼Œæ·»åŠ é«˜çº§æ¨¡å¼æ›´æ–°
        const originalGenerateKey = generateKey;
        generateKey = async function() {
            await originalGenerateKey.call(this);
            updateAdvancedKeyDisplay();
        };
        
        // é‡å†™çš„toggleAutoDecryptå‡½æ•°ï¼Œåªæ˜¾ç¤ºæç¤ºä¿¡æ¯ï¼Œä¸æ‰§è¡Œåˆ‡æ¢æ“ä½œ
        const originalToggleAutoDecrypt = toggleAutoDecrypt;
        toggleAutoDecrypt = function() {
            originalToggleAutoDecrypt.call(this);
            // çŠ¶æ€å§‹ç»ˆæ˜¯å¼€å¯ï¼Œä¸éœ€è¦æ›´æ–°
        };
        
        // å…¨å±€å˜é‡ï¼šå¯†é’¥åˆ—è¡¨
        let keyList = [];
        let songLibrary = [];
        
        // è‡ªåŠ¨ç”Ÿæˆè®¾å¤‡ç å’Œå¯†é’¥
        async function autoGenerateKeys() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»ç”Ÿæˆè¿‡
            const savedDeviceCode = localStorage.getItem('autoDeviceCode');
            const savedKeys = localStorage.getItem('autoKeyList');
            
            if (!savedDeviceCode || !savedKeys) {
                // ç”Ÿæˆè®¾å¤‡ç 
                const deviceCode = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                
                // ç”Ÿæˆ5ä¸ªå¯†é’¥
                const keys = [];
                for (let i = 0; i < 5; i++) {
                    const key = await generateKeyFromDeviceCode(deviceCode + i);
                    keys.push(key);
                }
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('autoDeviceCode', deviceCode);
                localStorage.setItem('autoKeyList', JSON.stringify(keys));
                
                // æ›´æ–°ç•Œé¢
                document.getElementById('device-code').value = deviceCode;
                document.getElementById('advanced-device-code').value = deviceCode;
                
                // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯†é’¥ä½œä¸ºå½“å‰å¯†é’¥
                currentKey = keys[0];
                updateAdvancedKeyDisplay();
            } else {
                // åŠ è½½å·²ä¿å­˜çš„è®¾å¤‡ç å’Œå¯†é’¥
                const deviceCode = savedDeviceCode;
                const keys = JSON.parse(savedKeys);
                
                document.getElementById('device-code').value = deviceCode;
                document.getElementById('advanced-device-code').value = deviceCode;
                
                currentKey = keys[0];
                updateAdvancedKeyDisplay();
            }
        }
        
        // åŠ è½½æ­Œæ›²åº“
        function loadSongLibrary() {
            const savedLibrary = localStorage.getItem('songLibrary');
            if (savedLibrary) {
                songLibrary = JSON.parse(savedLibrary);
                updateSongLibraryDisplay();
            }
        }
        
        // ä¿å­˜æ­Œæ›²åº“
        function saveSongLibrary() {
            localStorage.setItem('songLibrary', JSON.stringify(songLibrary));
        }
        
        // æ›´æ–°æ­Œæ›²åº“æ˜¾ç¤º
        function updateSongLibraryDisplay() {
            const songLibraryElement = document.getElementById('song-library');
            
            if (songLibrary.length === 0) {
                songLibraryElement.innerHTML = '<p>æš‚æ— æ­Œæ›²ï¼Œç‚¹å‡»"æ‰‹åŠ¨æ‰«æå¯¼å…¥"æˆ–"ä¸Šä¼ æ–‡ä»¶å¤¹å¯¼å…¥"æ·»åŠ æ­Œæ›²</p>';
                return;
            }
            
            let html = '<ul style="list-style-type: none; padding: 0;">';
            songLibrary.forEach((song, index) => {
                const isEncrypted = ['.smp3', '.sflac', '.lgg', '.lav'].some(ext => song.name.toLowerCase().endsWith(ext));
                html += `
                    <li style="background: #f8f9fa; padding: 10px; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${song.name}</strong><br>
                            <small>${(song.size / (1024 * 1024)).toFixed(2)} MB | ${isEncrypted ? 'åŠ å¯†' : 'éåŠ å¯†'}</small>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="playFromLibrary(${index})" style="padding: 4px 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">æ’­æ”¾</button>
                            <button onclick="playNext(${index})" style="padding: 4px 8px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer;" title="ä¸‹ä¸€é¦–æ’­æ”¾">ä¸‹ä¸€é¦–</button>
                            <button onclick="removeFromLibrary(${index})" style="padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            
            songLibraryElement.innerHTML = html;
        }
        
        // æ›´æ–°å½“å‰æ’­æ”¾æ˜¾ç¤º
        function updateCurrentPlaying(song) {
            const currentPlayingElement = document.getElementById('current-playing');
            if (song) {
                const isEncrypted = ['.smp3', '.sflac', '.lgg', '.lav'].some(ext => song.name.toLowerCase().endsWith(ext));
                currentPlayingElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>å½“å‰æ’­æ”¾:</strong> ${song.name}<br>
                            <small>${isEncrypted ? 'åŠ å¯†' : 'éåŠ å¯†'} | ${(song.size / (1024 * 1024)).toFixed(2)} MB</small>
                        </div>
                        <button onclick="stopCurrentPlay()" style="padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">åœæ­¢</button>
                    </div>
                `;
            } else {
                currentPlayingElement.innerHTML = '<p>æš‚æ— æ’­æ”¾å†…å®¹</p>';
            }
        }
        
        // æ’­æ”¾å…¨éƒ¨æ­Œæ›²
        function playAllSongs() {
            if (songLibrary.length > 0) {
                // ä¿å­˜å½“å‰æ’­æ”¾ç´¢å¼•
                window.currentPlayIndex = 0;
                playFromLibrary(0);
            } else {
                showMessage('æ­Œæ›²åˆ—è¡¨ä¸ºç©º', 'error');
            }
        }
        
        // æ¸…ç©ºæ­Œæ›²åˆ—è¡¨
        function clearSongList() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ­Œæ›²åˆ—è¡¨å—ï¼Ÿ')) {
                // é‡Šæ”¾æ‰€æœ‰URLå¯¹è±¡
                songLibrary.forEach(song => {
                    URL.revokeObjectURL(song.url);
                });
                songLibrary = [];
                saveSongLibrary();
                updateSongLibraryDisplay();
                updateCurrentPlaying(null);
                showMessage('æ­Œæ›²åˆ—è¡¨å·²æ¸…ç©º', 'success');
            }
        }
        
        // ä»æ­Œæ›²åº“æ’­æ”¾
        function playFromLibrary(index) {
            if (songLibrary[index]) {
                const song = songLibrary[index];
                const audioPlayer = document.getElementById('audio-player');
                
                // æ›´æ–°å½“å‰æ’­æ”¾ç´¢å¼•
                window.currentPlayIndex = index;
                
                // ç›´æ¥æ’­æ”¾ï¼Œæ”¯æŒéåŠ å¯†å’ŒåŠ å¯†æ ¼å¼
                audioPlayer.src = song.url;
                audioPlayer.play();
                
                // æ›´æ–°å½“å‰æ’­æ”¾æ˜¾ç¤º
                updateCurrentPlaying(song);
                
                showMessage(`æ­£åœ¨æ’­æ”¾: ${song.name}`, 'success');
            }
        }
        
        // ä¸‹ä¸€é¦–æ’­æ”¾
        function playNext(index) {
            // å°†æŒ‡å®šæ­Œæ›²ç§»åˆ°å½“å‰æ’­æ”¾ç´¢å¼•å
            if (index >= 0 && index < songLibrary.length) {
                const song = songLibrary.splice(index, 1)[0];
                const nextIndex = window.currentPlayIndex !== undefined ? window.currentPlayIndex + 1 : 0;
                songLibrary.splice(nextIndex, 0, song);
                saveSongLibrary();
                updateSongLibraryDisplay();
                showMessage(`${song.name} å°†ä½œä¸ºä¸‹ä¸€é¦–æ’­æ”¾`, 'success');
            }
        }
        
        // åœæ­¢å½“å‰æ’­æ”¾
        function stopCurrentPlay() {
            const audioPlayer = document.getElementById('audio-player');
            audioPlayer.pause();
            audioPlayer.src = '';
            updateCurrentPlaying(null);
            showMessage('å·²åœæ­¢æ’­æ”¾', 'info');
        }
        
        // ç›‘å¬éŸ³é¢‘æ’­æ”¾ç»“æŸäº‹ä»¶ï¼Œè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–
        document.getElementById('audio-player').addEventListener('ended', function() {
            if (window.currentPlayIndex !== undefined && window.currentPlayIndex < songLibrary.length - 1) {
                // æ’­æ”¾ä¸‹ä¸€é¦–
                window.currentPlayIndex++;
                playFromLibrary(window.currentPlayIndex);
            } else {
                // æ’­æ”¾ç»“æŸ
                updateCurrentPlaying(null);
                showMessage('æ’­æ”¾åˆ—è¡¨å·²ç»“æŸ', 'info');
            }
        });
        
        // æ‰‹åŠ¨æ‰«æå¯¼å…¥æ­Œæ›²
        function manualScan() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.mp3,.flac,.wav,.smp3,.sflac,.lgg,.lav';
            input.multiple = true;
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    addToSongLibrary(files);
                }
            };
            input.click();
        }
        
        // æ·»åŠ æ–‡ä»¶åˆ°æ­Œæ›²åˆ—è¡¨
        function addToSongLibrary(files) {
            let addedCount = 0;
            
            files.forEach(file => {
                // æ£€æŸ¥æ˜¯å¦æ˜¯éŸ³é¢‘æ–‡ä»¶
                const audioExtensions = ['.mp3', '.flac', '.wav', '.smp3', '.sflac', '.lgg', '.lav'];
                const fileName = file.name.toLowerCase();
                const isAudio = audioExtensions.some(ext => fileName.endsWith(ext));
                
                if (isAudio) {
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    const exists = songLibrary.some(song => song.name === file.name && song.size === file.size);
                    if (!exists) {
                        // è½¬æ¢ä¸ºå¯åºåˆ—åŒ–çš„å¯¹è±¡
                        const song = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            lastModified: file.lastModified,
                            url: URL.createObjectURL(file)
                        };
                        songLibrary.push(song);
                        addedCount++;
                    }
                }
            });
            
            if (addedCount > 0) {
                saveSongLibrary();
                updateSongLibraryDisplay();
                showMessage(`æˆåŠŸæ·»åŠ  ${addedCount} é¦–æ­Œæ›²åˆ°æ­Œæ›²åˆ—è¡¨`, 'success');
            } else {
                showMessage('æœªæ‰¾åˆ°æ–°çš„éŸ³é¢‘æ–‡ä»¶', 'info');
            }
        }
        
        // ä»æ­Œæ›²åº“æ’­æ”¾
        function playFromLibrary(index) {
            if (songLibrary[index]) {
                const song = songLibrary[index];
                const audioPlayer = document.getElementById('audio-player');
                audioPlayer.src = song.url;
                audioPlayer.play();
                showMessage(`æ­£åœ¨æ’­æ”¾: ${song.name}`, 'success');
            }
        }
        // ä»æ­Œæ›²åº“åˆ é™¤
        function removeFromLibrary(index) {
            if (songLibrary[index]) {
                // é‡Šæ”¾URLå¯¹è±¡
                URL.revokeObjectURL(songLibrary[index].url);
                songLibrary.splice(index, 1);
                saveSongLibrary();
                updateSongLibraryDisplay();
                showMessage('æ­Œæ›²å·²åˆ é™¤', 'success');
            }
        }
        
        // è‡ªåŠ¨æ‰«æåŠŸèƒ½ï¼ˆåŸºäºlocalStorageï¼‰
        function autoScan() {
            // ä»localStorageåŠ è½½æ­Œæ›²åº“
            loadSongLibrary();
            showMessage('è‡ªåŠ¨æ‰«æå®Œæˆ', 'success');
        }
        
        // ä»è®¾å¤‡ç ç”Ÿæˆå¯†é’¥
        async function generateKeyFromDeviceCode(deviceCode) {
            const encoder = new TextEncoder();
            const data = encoder.encode(deviceCode);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const keyHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return keyHex.substring(0, 32);
        }
        
        // é‡æ–°ç”Ÿæˆæ‰€æœ‰å¯†é’¥
        async function regenerateAllKeys() {
            const deviceCode = document.getElementById('advanced-device-code').value;
            if (!deviceCode) {
                showMessage('è¯·å…ˆè¾“å…¥è®¾å¤‡ç ', 'error');
                return;
            }
            
            // ç”Ÿæˆ5ä¸ªæ–°å¯†é’¥
            const keys = [];
            for (let i = 0; i < 5; i++) {
                const key = await generateKeyFromDeviceCode(deviceCode + i);
                keys.push(key);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('autoKeyList', JSON.stringify(keys));
            
            // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯†é’¥ä½œä¸ºå½“å‰å¯†é’¥
            currentKey = keys[0];
            updateAdvancedKeyDisplay();
            updateKeyListDisplay();
            
            showMessage('å·²é‡æ–°ç”Ÿæˆ5ä¸ªå¯†é’¥', 'success');
        }
        
        // æ›´æ–°å¯†é’¥åˆ—è¡¨æ˜¾ç¤º
        function updateKeyListDisplay() {
            const savedKeys = localStorage.getItem('autoKeyList');
            if (savedKeys) {
                keyList = JSON.parse(savedKeys);
                const keyListElement = document.getElementById('key-list');
                if (keyListElement) {
                    keyListElement.innerHTML = '';
                    keyList.forEach((key, index) => {
                        const keyItem = document.createElement('div');
                        keyItem.className = 'setting-value';
                        keyItem.style.marginBottom = '8px';
                        keyItem.innerHTML = `
                            <strong>å¯†é’¥ ${index + 1}:</strong> ${key}
                            <button onclick="useKey(${index})" style="margin-left: 10px; padding: 4px 8px; font-size: 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">ä½¿ç”¨</button>
                            <button onclick="removeKey(${index})" style="margin-left: 5px; padding: 4px 8px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
                        `;
                        keyListElement.appendChild(keyItem);
                    });
                }
            }
        }
        
        // ä½¿ç”¨æŒ‡å®šç´¢å¼•çš„å¯†é’¥
        function useKey(index) {
            if (keyList[index]) {
                currentKey = keyList[index];
                updateAdvancedKeyDisplay();
                showMessage(`å·²åˆ‡æ¢åˆ°å¯†é’¥ ${index + 1}`, 'success');
            }
        }
        
        // åˆ é™¤æŒ‡å®šç´¢å¼•çš„å¯†é’¥
        function removeKey(index) {
            if (keyList[index]) {
                // ä»åˆ—è¡¨ä¸­åˆ é™¤
                keyList.splice(index, 1);
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('autoKeyList', JSON.stringify(keyList));
                
                // æ›´æ–°æ˜¾ç¤º
                updateKeyListDisplay();
                
                // å¦‚æœå½“å‰ä½¿ç”¨çš„å¯†é’¥è¢«åˆ é™¤ï¼Œé‡ç½®ä¸ºç¬¬ä¸€ä¸ªå¯†é’¥
                if (currentKey === keyList[index]) {
                    if (keyList.length > 0) {
                        currentKey = keyList[0];
                        updateAdvancedKeyDisplay();
                    } else {
                        currentKey = null;
                        updateAdvancedKeyDisplay();
                    }
                }
                
                showMessage('å¯†é’¥å·²åˆ é™¤', 'success');
            }
        }
        
        // æ·»åŠ æ–°å¯†é’¥
        function addKey() {
            const keyInput = document.getElementById('new-key-input');
            const newKey = keyInput.value.trim();
            
            // éªŒè¯å¯†é’¥æ ¼å¼ï¼ˆ32ä½åå…­è¿›åˆ¶å­—ç¬¦ï¼‰
            const hexRegex = /^[0-9a-fA-F]{32}$/;
            if (!hexRegex.test(newKey)) {
                showMessage('å¯†é’¥æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»æ˜¯32ä½åå…­è¿›åˆ¶å­—ç¬¦', 'error');
                return;
            }
            
            // æ£€æŸ¥å¯†é’¥æ˜¯å¦å·²å­˜åœ¨
            if (keyList.includes(newKey)) {
                showMessage('è¯¥å¯†é’¥å·²å­˜åœ¨', 'error');
                return;
            }
            
            // æ·»åŠ åˆ°å¯†é’¥åˆ—è¡¨
            keyList.push(newKey);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('autoKeyList', JSON.stringify(keyList));
            
            // æ›´æ–°æ˜¾ç¤º
            updateKeyListDisplay();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            keyInput.value = '';
            
            showMessage('å¯†é’¥æ·»åŠ æˆåŠŸ', 'success');
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            initAudioEventListeners();
            updateVolumeDisplay();
            updateAutoDecryptStatus();
            
            // åˆå§‹åŒ–éŸ³é¢‘åŠ å¯†ä¿æŠ¤åŠŸèƒ½
            const savedProtectionStatus = localStorage.getItem('isEncryptionProtectionEnabled');
            if (savedProtectionStatus !== null) {
                isEncryptionProtectionEnabled = savedProtectionStatus === 'true';
            }
            updateEncryptionProtectionStatus();
            
            // ä¸ºåŠ å¯†ä¿æŠ¤å¼€å…³æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const switchElement = document.getElementById('encryption-protection-switch');
            if (switchElement) {
                switchElement.addEventListener('change', toggleEncryptionProtection);
            }
            
            // è‡ªåŠ¨ç”Ÿæˆè®¾å¤‡ç å’Œå¯†é’¥
            await autoGenerateKeys();
            updateKeyListDisplay();
            
            // åŠ è½½æ­Œæ›²åº“ï¼ˆè‡ªåŠ¨æ‰«æï¼‰
            loadSongLibrary();
            
            // åˆå§‹åŒ–è‡ªåŠ¨è§£å¯†ç›‘å¬
            initAutoDecryptListener();
        });
        
        // ç›‘å¬æ–‡ä»¶é€‰æ‹©äº‹ä»¶ï¼Œæ”¯æŒå¤šé€‰
        document.getElementById('audio-file').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
                const fileInfo = `å…±é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶<br>æ€»å¤§å°: ${(files.reduce((total, file) => total + file.size, 0) / (1024 * 1024)).toFixed(2)} MB`;
                document.getElementById('file-info').innerHTML = fileInfo;
                
                // è®¾ç½®å½“å‰æ–‡ä»¶ä¸ºç¬¬ä¸€ä¸ªæ–‡ä»¶
                currentFile = files[0];
            }
        });
        
        // ç›‘å¬æ–‡ä»¶å¤¹é€‰æ‹©äº‹ä»¶
        document.getElementById('folder-upload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
                const fileInfo = `å…±é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶<br>æ€»å¤§å°: ${(files.reduce((total, file) => total + file.size, 0) / (1024 * 1024)).toFixed(2)} MB`;
                document.getElementById('file-info').innerHTML = fileInfo;
                
                // è‡ªåŠ¨æ·»åŠ åˆ°æ­Œæ›²åˆ—è¡¨
                addToSongLibrary(files);
            }
        });
        
        // ä¸Šä¼ æ–‡ä»¶å¤¹å¯¼å…¥
        function uploadFolder() {
            document.getElementById('folder-upload').click();
        }
        
        // ä¸€é”®æ‰«æå¯¼å…¥
        function oneClickScan() {
            // åˆ›å»ºä¸€ä¸ªæ¨¡æ€å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 12px;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            modalContent.innerHTML = `
                <h3 style="color: #667eea; margin-bottom: 20px; text-align: center;">ä¸€é”®æ‰«æå¯¼å…¥</h3>
                <p style="margin-bottom: 20px; text-align: center;">é€‰æ‹©å¯¼å…¥æ–¹å¼</p>
                <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 20px;">
                    <button onclick="oneClickScanFile()" style="
                        flex: 1;
                        padding: 15px;
                        background: #3498db;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 16px;
                        transition: all 0.3s;
                    ">ğŸ“„ é€‰æ‹©æ–‡ä»¶</button>
                    <button onclick="oneClickScanFolder()" style="
                        flex: 1;
                        padding: 15px;
                        background: #2ecc71;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 16px;
                        transition: all 0.3s;
                    ">ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹</button>
                </div>
                <button onclick="closeModal()" style="
                    width: 100%;
                    padding: 10px;
                    background: #95a5a6;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                ">å–æ¶ˆ</button>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // ä¿å­˜æ¨¡æ€æ¡†å¼•ç”¨
            window.oneClickScanModal = modal;
        }
        
        // ä¸€é”®æ‰«æ - é€‰æ‹©æ–‡ä»¶
        function oneClickScanFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.mp3,.flac,.wav,.smp3,.sflac,.lgg,.lav';
            input.multiple = true;
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    addToSongLibrary(files);
                }
                closeModal();
            };
            input.click();
        }
        
        // ä¸€é”®æ‰«æ - é€‰æ‹©æ–‡ä»¶å¤¹
        function oneClickScanFolder() {
            const input = document.createElement('input');
            input.type = 'file';
            input.webkitdirectory = true;
            input.mozdirectory = true;
            input.directory = true;
            input.accept = '.mp3,.flac,.wav,.smp3,.sflac,.lgg,.lav';
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
                    const fileInfo = `å…±é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶<br>æ€»å¤§å°: ${(files.reduce((total, file) => total + file.size, 0) / (1024 * 1024)).toFixed(2)} MB`;
                    document.getElementById('file-info').innerHTML = fileInfo;
                    
                    // è‡ªåŠ¨æ·»åŠ åˆ°æ­Œæ›²åˆ—è¡¨
                    addToSongLibrary(files);
                }
                closeModal();
            };
            input.click();
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            if (window.oneClickScanModal) {
                document.body.removeChild(window.oneClickScanModal);
                window.oneClickScanModal = null;
            }
        }
    </script>
</body>
</html>